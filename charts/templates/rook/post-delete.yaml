---
apiVersion: batch/v1
kind: Job
metadata:
  name: rook-post-delete
  # TODO: SA 만들어서 rook-ceph에서 수행하도록 변경
  namespace: kube-system
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": hook-succeeded
  labels:
    app: rook-post-delete
spec:
  template:
    metadata:
      name: rook-post-delete
      labels:
        app: rook-post-delete
    spec:
      serviceAccountName: default
      containers:
        - name: kubectl
          image: {{ .Values.storage.images.hyperkube.repository }}:{{ .Values.storage.images.hyperkube.tag }}
          imagePullPolicy: IfNotPresent
          command:
          - /bin/sh
          - -c
          - >
              kubectl delete crd cephblockpools.ceph.rook.io;
              kubectl delete crd cephclients.ceph.rook.io;
              kubectl delete crd cephclusters.ceph.rook.io;
              kubectl delete crd cephfilesystems.ceph.rook.io;
              kubectl delete crd cephnfses.ceph.rook.io;
              kubectl delete crd cephobjectstores.ceph.rook.io;
              kubectl delete crd cephobjectstoreusers.ceph.rook.io;
              kubectl delete crd objectbucketclaims.objectbucket.io;
              kubectl delete crd objectbuckets.objectbucket.io;
              kubectl delete crd volumes.rook.io;
      restartPolicy: OnFailure

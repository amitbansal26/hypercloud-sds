variables:
  GIT_SUBMODULE_STRATEGY: recursive
stages:
  - lint_check
  - build
  - e2e_test
  - cleanup
  - release

.e2e_on_cluster_template:
  stage: e2e_test
  script:
    - ./hack/prolinux_cluster.sh up
    - ./hcsctl/build/hcsctl install ./hack/inventory/test-sample
    - ./hcsctl/build/hcsctl ceph status
    - ./hcsctl/build/hcsctl ceph exec ceph osd status
    - ./hcsctl/build/hcsctl.test
    - ./hcsctl/build/hcsctl uninstall ./hack/inventory/test-sample
    - ./hcsctl/build/hcsctl uninstall ./hack/inventory/test-sample # idempotent

golangci_lint_check:
  stage: lint_check
  script:
    - make check -C hcsctl
  tags:
    - prolinux

hcsctl_build:
  stage: build
  script:
    - make -C hcsctl
  artifacts:
    expire_in: '1 day'
    paths:
      - hcsctl/build/
  tags:
    - prolinux

prolinux_v1_15_3_calico:
  extends: .e2e_on_cluster_template
  before_script:
    - export BOX_OS=prolinux KUBE_VERSION=v1.15.3 KUBE_NETWORK=calico
  tags:
    - prolinux

prolinux_v1_15_3_flannel:
  extends: .e2e_on_cluster_template
  before_script:
    - export BOX_OS=prolinux KUBE_VERSION=v1.15.3 KUBE_NETWORK=flannel
  tags:
    - prolinux

prolinux_v1_16_8_calico:
  extends: .e2e_on_cluster_template
  before_script:
    - export BOX_OS=prolinux KUBE_VERSION=v1.16.8 KUBE_NETWORK=calico
  tags:
    - prolinux

prolinux_v1_16_8_flannel:
  extends: .e2e_on_cluster_template
  before_script:
    - export BOX_OS=prolinux KUBE_VERSION=v1.16.8 KUBE_NETWORK=flannel
  tags:
    - prolinux

prolinux_v1_15_3_calico_with_another_kubeconfigpath:
  stage: e2e_test
  before_script:
    - export BOX_OS=prolinux KUBE_VERSION=v1.15.3 KUBE_NETWORK=calico
  script:
    - ./hack/prolinux_cluster.sh up
    - mv $HOME/.kube/config $HOME/config
    - ./hcsctl/build/hcsctl install ./hack/inventory/test-sample --kubeconfig $HOME/config
    - ./hcsctl/build/hcsctl ceph status --kubeconfig=$HOME/config
    - ./hcsctl/build/hcsctl uninstall ./hack/inventory/test-sample --kubeconfig $HOME/config
    - mv $HOME/config $HOME/.kube/config
  tags:
    - prolinux

prolinux_nodes_poweroff:
  stage: cleanup
  script:
    - ./hack/prolinux_cluster.sh down
  when: always
  tags:
    - prolinux

release:
  stage: release
  script:
    - gitlab-release --message "${CI_COMMIT_MESSAGE}" ./hcsctl/build/hcsctl ./hcsctl/build/hcsctl.test
  only:
    - tags
  tags:
    - prolinux
